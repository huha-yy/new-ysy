# 户外徒步活动管理系统 - 功能模块设计文档

## 一、系统概述

本系统是一个基于SpringBoot的户外徒步活动管理平台，采用B/S架构、前后端分离设计。系统服务于四类角色：**参与者**、**组织者**、**系统管理员**和**平台系统**，覆盖从活动发布、报名审核、行前准备、签到监控到评价反馈的完整业务闭环。

---

## 二、系统角色定义

| 角色 | 说明 | 主要职责 |
|------|------|----------|
| 参与者 | 普通注册用户，徒步爱好者 | 浏览活动、报名参与、签到打卡、评价反馈 |
| 组织者 | 发起活动的用户 | 发布活动、审核报名、制定集合方案、处理异常 |
| 系统管理员 | 平台管理人员 | 活动合规审核、轨迹监控、数据统计分析 |
| 平台系统 | 系统自动化处理 | 信息校验、资格检索、通知推送、热度更新 |

---

## 三、功能模块详细设计

### 模块1：用户管理

#### 1.1 功能概述
实现用户的注册、登录与身份认证，支持个人信息管理，为活动安全提供数据支撑。

#### 1.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| U-01 | 用户注册 | 填写手机号/邮箱、密码、基本信息完成注册 | 游客 |
| U-02 | 用户登录 | 通过账号密码登录系统，获取JWT令牌 | 所有用户 |
| U-03 | 密码找回 | 通过手机号/邮箱验证码重置密码 | 所有用户 |
| U-04 | 个人信息管理 | 编辑个人资料（头像、昵称、性别、年龄等） | 参与者/组织者 |
| U-05 | 徒步档案管理 | 维护徒步经验等级、健康状况、紧急联系人、装备清单 | 参与者 |
| U-06 | 偏好设置 | 设置活动偏好标签（强度、里程、海拔、地区、时间档） | 参与者 |

#### 1.3 业务规则
- 手机号/邮箱全局唯一，作为登录账号
- 徒步经验等级分为：新手、初级、中级、高级、专业
- 紧急联系人信息为报名必填项

---

### 模块2：活动管理

#### 2.1 功能概述
组织者发布徒步活动，系统管理员进行合规审核，参与者浏览和查看活动详情。

#### 2.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| A-01 | 发布活动 | 填写活动信息并提交审核 | 组织者 |
| A-02 | 活动审核 | 审核活动合规性与安全性 | 系统管理员 |
| A-03 | 活动列表 | 分页展示活动列表，支持多条件筛选 | 参与者 |
| A-04 | 活动详情 | 查看活动完整信息（路线、费用、须知等） | 参与者 |
| A-05 | 活动编辑 | 修改已发布活动的信息（审核前/驳回后） | 组织者 |
| A-06 | 活动状态管理 | 管理活动状态：草稿/待审核/已发布/进行中/已结束/已取消 | 组织者/系统 |
| A-07 | 活动完成标记 | 活动结束后标记完成状态 | 系统自动 |
| A-08 | 我的活动 | 查看自己发布/参与的活动列表 | 组织者/参与者 |

#### 2.3 活动信息字段
- 基本信息：活动标题、活动封面、活动简介
- 时间信息：活动日期、集合时间、预计时长
- 地点信息：集合地点、目的地、途经点
- 路线信息：路线难度、总里程、累计爬升、风险点
- 限制信息：人数上限、报名截止时间、费用说明
- 要求信息：体能要求、装备要求、经验要求、年龄限制

#### 2.4 活动状态流转
```
草稿 → 待审核 → 已发布 → 报名中 → 进行中 → 已结束
                ↓
              已驳回 → 重新编辑 → 待审核
                ↓
              已取消
```

#### 2.5 业务规则
- 活动发布前需通过系统管理员审核
- 审核未通过需说明驳回原因
- 活动开始后不可修改核心信息
- 活动取消需通知所有已报名参与者

---

### 模块3：报名管理

#### 3.1 功能概述
参与者筛选并报名活动，系统进行资格校验，组织者审核报名申请，支持候补与通知机制。

#### 3.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| R-01 | 活动筛选 | 按难度、地区、时间、费用等条件筛选活动 | 参与者 |
| R-02 | 提交报名 | 填写报名信息并提交 | 参与者 |
| R-03 | 信息校验 | 校验报名信息完整性 | 系统自动 |
| R-04 | 资格检索 | 检查用户资格与活动容量 | 系统自动 |
| R-05 | 报名审核 | 审核参与者报名申请 | 组织者 |
| R-06 | 候补排队 | 名额已满时进入候补队列 | 系统自动 |
| R-07 | 名额释放 | 取消报名后释放名额给候补 | 系统自动 |
| R-08 | 取消报名 | 参与者主动取消报名 | 参与者 |
| R-09 | 报名通知 | 发送审核结果通知 | 系统自动 |
| R-10 | 报名列表 | 查看活动的报名人员列表 | 组织者 |

#### 3.3 报名状态
- 待审核：已提交，等待组织者审核
- 审核通过：报名成功
- 审核未通过：报名被拒绝
- 候补中：名额已满，排队等待
- 已取消：用户主动取消
- 已缺席：未参加活动（记录）

#### 3.4 业务规则
- 报名需校验用户资格（经验等级、健康状况符合活动要求）
- 报名需校验活动容量（剩余名额 > 0）
- 同一用户不可重复报名同一活动
- 报名截止后不可提交新报名
- 全流程不涉及在线支付

---

### 模块4：集合管理

#### 4.1 功能概述
活动报名审核完成后，组织者制定并发布集合方案，参与者接收准备信息。

#### 4.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| G-01 | 制定集合方案 | 设置集合时间、地点、注意事项、携带物品 | 组织者 |
| G-02 | 发布集合要求 | 向所有通过审核的参与者发布集合通知 | 组织者 |
| G-03 | 接收准备信息 | 查看集合方案详情与准备事项 | 参与者 |
| G-04 | 确认出行 | 参与者确认收到通知并确认出行 | 参与者 |
| G-05 | 集合方案修改 | 修改集合方案（活动开始前） | 组织者 |

#### 4.3 集合方案内容
- 集合时间：具体日期与时间
- 集合地点：详细地址、地图定位
- 交通指引：公共交通/自驾路线说明
- 携带物品：必备装备清单
- 注意事项：天气预报、安全提示、特殊要求
- 紧急联系：组织者联系方式

#### 4.4 业务规则
- 集合方案需在活动开始前发布
- 方案修改需重新通知参与者
- 活动当天发送集合提醒

---

### 模块5：路线管理

#### 5.1 功能概述
集成高德地图API，提供路线规划、海拔分析、风险点标注和GPS轨迹记录功能。

#### 5.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| L-01 | 路线规划 | 在地图上规划徒步路线 | 组织者 |
| L-02 | 路线点位管理 | 添加/编辑/删除路线途经点 | 组织者 |
| L-03 | 海拔分析 | 展示路线海拔剖面图 | 组织者/参与者 |
| L-04 | 风险点标注 | 标注路线上的危险区域与注意点 | 组织者 |
| L-05 | 路线预览 | 在地图上查看完整路线 | 参与者 |
| L-06 | 离线地图 | 下载离线地图数据 | 参与者 |
| L-07 | GPS轨迹记录 | 实时记录用户位置轨迹 | 系统自动 |
| L-08 | 轨迹回放 | 活动结束后查看轨迹回放 | 参与者/组织者 |

#### 5.3 路线信息
- 起点、终点坐标
- 途经点列表（坐标、名称、说明）
- 签到点列表（坐标、签到半径）
- 风险点列表（坐标、风险类型、提示信息）
- 路线总里程、累计爬升/下降
- 难度等级：休闲、简单、中等、困难、极限

#### 5.4 业务规则
- 路线至少包含起点和终点
- 签到点需设置有效签到半径（默认100米）
- 风险点类型：陡坡、落石、涉水、迷路易发区等

---

### 模块6：签到管理

#### 6.1 功能概述
提供多点签到功能，平台实时监控位置与进度，异常情况触发安全预警。

#### 6.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| C-01 | 集合签到 | 在集合点进行GPS定位签到 | 参与者 |
| C-02 | 中途签到 | 在途中关键点进行GPS签到 | 参与者 |
| C-03 | 终点签到 | 在终点进行GPS签到，完成活动 | 参与者 |
| C-04 | 签到状态查看 | 查看自己/团队的签到进度 | 参与者/组织者 |
| C-05 | 位置上报 | 定时上报GPS位置 | 系统自动 |
| C-06 | 轨迹监控 | 实时监控参与者位置与轨迹 | 系统管理员 |
| C-07 | 偏离检测 | 检测参与者是否偏离预定路线 | 系统自动 |
| C-08 | 静止检测 | 检测参与者是否长时间静止 | 系统自动 |
| C-09 | 预警触发 | 异常情况触发安全预警 | 系统自动 |
| C-10 | 异常处理 | 根据预警做出对应处理措施 | 组织者 |

#### 6.3 签到规则
- 签到需在签到点有效半径内（默认100米）
- 签到需开启GPS定位权限
- 签到时记录：时间、坐标、签到点ID

#### 6.4 预警规则
| 异常类型 | 触发条件 | 预警级别 |
|----------|----------|----------|
| 偏离路线 | 距离预定路线超过500米 | 警告 |
| 严重偏离 | 距离预定路线超过1000米 | 严重 |
| 长时间静止 | 同一位置停留超过30分钟 | 警告 |
| 超时未签到 | 超过预计时间未到达签到点 | 警告 |
| 失联 | 超过1小时无位置更新 | 严重 |

#### 6.5 业务规则
- 预警发送给组织者和系统管理员
- 预警记录存入事件日志
- 组织者可标记预警处理状态

#### 6.6 技术实现说明（重要）

> ⚠️ **开发注意事项**：本模块涉及GPS定位技术，以下是实现要点。

##### 6.6.1 GPS定位方案

本系统为**纯网页端**，通过手机浏览器访问，使用 **HTML5 Geolocation API** 获取用户GPS位置。

| 方案 | 说明 | 推荐度 |
|------|------|--------|
| HTML5 Geolocation API | 浏览器原生API，兼容性好 | ⭐⭐ |
| 高德地图 JS API 定位 | 已集成高德地图，可直接使用其定位插件 | ⭐⭐⭐ 推荐 |

##### 6.6.2 前端实现要点

```
【前端技术要点】

1. 定位API选择：
   - 推荐使用高德地图 JS API 的 AMap.Geolocation 插件
   - 备选：navigator.geolocation（浏览器原生）

2. 定位参数配置：
   - enableHighAccuracy: true    // 启用高精度模式
   - timeout: 10000              // 超时时间10秒
   - maximumAge: 0               // 不使用缓存位置

3. 返回数据：
   - latitude: 纬度
   - longitude: 经度
   - accuracy: 精度（米）

4. 错误处理：
   - PERMISSION_DENIED: 用户拒绝授权 → 提示必须开启定位
   - POSITION_UNAVAILABLE: 无法获取位置 → 提示检查GPS设置
   - TIMEOUT: 获取超时 → 提示重试

5. 签到请求数据：
   - activityId: 活动ID
   - checkpointId: 签到点ID
   - latitude: 用户纬度
   - longitude: 用户经度
   - timestamp: 签到时间戳
```

##### 6.6.3 后端实现要点

```
【后端技术要点】

1. 距离计算算法：Haversine公式
   - 输入：用户坐标(lat1, lng1)、签到点坐标(lat2, lng2)
   - 输出：两点间距离（米）
   - 地球半径常量：6371000米

2. 签到校验逻辑：
   - 计算用户位置与签到点的距离
   - 判断距离 <= 签到点有效半径（默认100米）
   - 通过则记录签到，否则返回"不在签到范围内"

3. 签到记录存储：
   - user_id: 用户ID
   - activity_id: 活动ID
   - checkpoint_id: 签到点ID
   - check_in_time: 签到时间
   - latitude: 签到时纬度
   - longitude: 签到时经度
   - status: 签到状态（正常/迟到/补签）

4. 位置上报（轨迹记录）：
   - 前端定时上报位置（建议间隔：30秒-1分钟）
   - 后端批量存储轨迹点
   - 用于轨迹回放和偏离检测
```

##### 6.6.4 部署环境要求

| 要求 | 说明 | 必要性 |
|------|------|--------|
| **HTTPS** | Geolocation API 要求安全上下文，生产环境必须使用HTTPS | ⭐⭐⭐ 必须 |
| localhost例外 | 本地开发时 localhost 可使用HTTP | 开发阶段 |
| SSL证书 | 生产部署需申请SSL证书（推荐：Let's Encrypt 免费证书） | 部署时 |

##### 6.6.5 签到流程时序

```
┌──────────┐       ┌──────────┐       ┌──────────┐       ┌──────────┐
│  用户     │       │  前端页面 │       │  后端API │       │  数据库   │
└────┬─────┘       └────┬─────┘       └────┬─────┘       └────┬─────┘
     │                  │                  │                  │
     │  1.点击签到按钮   │                  │                  │
     │─────────────────>│                  │                  │
     │                  │                  │                  │
     │  2.请求位置权限   │                  │                  │
     │<─────────────────│                  │                  │
     │                  │                  │                  │
     │  3.授权并返回GPS  │                  │                  │
     │─────────────────>│                  │                  │
     │                  │                  │                  │
     │                  │  4.发送签到请求   │                  │
     │                  │  (经纬度+签到点)  │                  │
     │                  │─────────────────>│                  │
     │                  │                  │                  │
     │                  │                  │  5.查询签到点坐标 │
     │                  │                  │─────────────────>│
     │                  │                  │<─────────────────│
     │                  │                  │                  │
     │                  │                  │  6.计算距离       │
     │                  │                  │  (Haversine公式)  │
     │                  │                  │                  │
     │                  │                  │  7.距离<=半径?    │
     │                  │                  │  是→记录签到      │
     │                  │                  │─────────────────>│
     │                  │                  │<─────────────────│
     │                  │                  │                  │
     │                  │  8.返回签到结果   │                  │
     │                  │<─────────────────│                  │
     │                  │                  │                  │
     │  9.显示签到成功   │                  │                  │
     │<─────────────────│                  │                  │
     │                  │                  │                  │
```

##### 6.6.6 注意事项清单

- [ ] 前端需处理用户拒绝授权的情况，给出明确提示
- [ ] 前端需处理GPS信号弱导致精度低的情况
- [ ] 后端需校验签到时间是否在活动进行时间范围内
- [ ] 后端需校验用户是否已报名该活动
- [ ] 后端需防止重复签到（同一签到点只能签一次）
- [ ] 生产环境必须部署HTTPS，否则定位功能无法使用
- [ ] 签到半径可配置，不同签到点可设置不同半径
- [ ] 轨迹数据量大时考虑分表或定期归档

---

### 模块7：评价反馈

#### 7.1 功能概述
活动结束后，参与者进行评分与评论，系统汇总生成排行与信誉度数据。

#### 7.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| E-01 | 活动评分 | 对已完成的活动进行1-5星评分 | 参与者 |
| E-02 | 活动评论 | 撰写活动评价文字 | 参与者 |
| E-03 | 评价列表 | 查看活动的所有评价 | 所有用户 |
| E-04 | 组织者信誉度 | 根据评价计算组织者信誉分 | 系统自动 |
| E-05 | 活动热度排行 | 根据参与人数、评分等生成热度榜 | 系统自动 |
| E-06 | 路线推荐指数 | 根据评价生成路线推荐分 | 系统自动 |

#### 7.3 评分维度
- 整体评价：1-5星
- 路线规划：路线合理性
- 组织安排：组织者服务质量
- 安全保障：安全措施到位程度

#### 7.4 业务规则
- 仅已完成活动的参与者可评价
- 每人每活动仅可评价一次
- 评价发布后不可修改
- 信誉度计算：最近N次活动评分加权平均

---

### 模块8：消息通知

#### 8.1 功能概述
系统在关键业务节点向用户推送通知消息。

#### 8.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| N-01 | 报名结果通知 | 报名审核通过/未通过通知 | 系统自动 |
| N-02 | 集合提醒 | 活动前一天/当天发送集合提醒 | 系统自动 |
| N-03 | 活动变更通知 | 活动信息变更通知参与者 | 系统自动 |
| N-04 | 安全预警通知 | 向组织者发送预警信息 | 系统自动 |
| N-05 | 候补成功通知 | 候补转正通知 | 系统自动 |
| N-06 | 评价提醒 | 活动结束后提醒参与者评价 | 系统自动 |
| N-07 | 消息列表 | 查看历史消息记录 | 所有用户 |
| N-08 | 消息已读标记 | 标记消息为已读 | 所有用户 |

#### 8.3 通知类型
- 站内消息：系统内消息列表
- 未来扩展：短信、邮件、APP推送

#### 8.4 业务规则
- 消息支持批量已读
- 保留历史消息记录

---

### 模块9：统计分析

#### 9.1 功能概述
系统自动统计活动数据，支持平台运营分析与合规巡检。

#### 9.2 功能清单

| 功能编号 | 功能名称 | 功能描述 | 操作角色 |
|----------|----------|----------|----------|
| S-01 | 活动数据统计 | 统计单个活动的参与情况 | 组织者 |
| S-02 | 签到统计 | 统计签到率、完成率 | 组织者/管理员 |
| S-03 | 热度榜更新 | 定时更新活动热度排行榜 | 系统自动 |
| S-04 | 平台数据概览 | 用户数、活动数、报名数等 | 系统管理员 |
| S-05 | 合规巡检 | 检查活动合规性、预警事件 | 系统管理员 |
| S-06 | 异常事件统计 | 统计预警事件分布与处理情况 | 系统管理员 |

#### 9.3 统计指标
- 活动统计：发布数、参与人次、完成率
- 用户统计：注册数、活跃数、组织者数
- 安全统计：预警次数、处理率、事故率

---

## 四、模块关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户管理                                 │
│                    (注册/登录/个人信息)                           │
└─────────────────────────────────────────────────────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        ▼                      ▼                      ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   活动管理     │───▶│   报名管理     │───▶│   集合管理     │
│ (发布/审核)    │    │ (报名/审核)    │    │ (方案/通知)    │
└───────────────┘    └───────────────┘    └───────────────┘
        │                                          │
        ▼                                          ▼
┌───────────────┐                        ┌───────────────┐
│   路线管理     │───────────────────────▶│   签到管理     │
│ (规划/标注)    │                        │ (签到/监控)    │
└───────────────┘                        └───────────────┘
                                                  │
                                                  ▼
                                         ┌───────────────┐
                                         │   评价反馈     │
                                         │ (评分/排行)    │
                                         └───────────────┘
                                                  │
        ┌─────────────────────────────────────────┤
        ▼                                         ▼
┌───────────────┐                        ┌───────────────┐
│   消息通知     │                        │   统计分析     │
│ (推送/提醒)    │                        │ (数据/报表)    │
└───────────────┘                        └───────────────┘
```

---

## 五、功能优先级

### 第一阶段（核心功能）
- ✅ 用户管理（注册、登录、个人信息）
- ✅ 活动管理（发布、审核、列表、详情）
- ✅ 报名管理（报名、审核、通知）
- ✅ 签到管理（集合签到、终点签到）

### 第二阶段（进阶功能）
- 🔄 路线管理（路线规划、地图展示）
- 🔄 集合管理（集合方案、准备通知）
- 🔄 签到管理（中途签到、位置监控）
- 🔄 评价反馈（评分、评论）

### 第三阶段（完善功能）
- ⏳ 消息通知（站内消息）
- ⏳ 统计分析（数据统计、热度榜）
- ⏳ 预警系统（偏离检测、异常处理）
- ⏳ 个性化推荐

---

## 六、文档版本

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2024-12-23 | 初稿，完成9大功能模块设计 | - |

