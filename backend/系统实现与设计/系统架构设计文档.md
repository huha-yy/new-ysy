# 户外徒步活动管理系统 - 系统架构设计文档

## 一、架构概述

### 1.1 架构模式

本系统采用 **B/S架构（Browser/Server）** + **前后端分离** 的设计模式。

| 架构特点 | 说明 |
|----------|------|
| B/S架构 | 用户通过浏览器访问，无需安装客户端 |
| 前后端分离 | 前端独立部署，通过API与后端交互 |
| RESTful API | 后端提供标准化的REST接口 |
| 单体应用 | 后端采用单体架构，适合中小型项目 |

### 1.2 技术选型

| 层次 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| **前端框架** | React | 18.x | 组件化开发 |
| **构建工具** | Vite | 5.x | 快速构建 |
| **UI组件库** | Ant Design | 5.x | 企业级UI组件 |
| **地图服务** | 高德地图 JS API | 2.0 | 路线规划、定位 |
| **HTTP客户端** | Axios | - | 前后端通信 |
| **后端框架** | SpringBoot | 3.x | 快速开发框架 |
| **ORM框架** | MyBatis-Plus | 3.5.x | 简化数据库操作 |
| **安全框架** | Spring Security + JWT | - | 认证与授权 |
| **数据库** | MySQL | 8.0 | 关系型数据库 |
| **JDK** | OpenJDK | 17 | Java运行环境 |

### 1.3 暂缓引入的技术

| 技术 | 原因 | 后续计划 |
|------|------|----------|
| Redis | 当前不考虑高并发场景 | 性能优化阶段引入 |
| WebSocket | 先用轮询方式过渡 | 实时性要求提高时引入 |

---

## 二、系统总体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                          │
│  ┌───────────────┐    ┌───────────────┐    ┌───────────────┐               │
│  │   参与者       │    │    组织者      │    │  系统管理员    │               │
│  │  (手机浏览器)  │    │  (PC/手机浏览器)│    │  (PC浏览器)   │               │
│  └───────┬───────┘    └───────┬───────┘    └───────┬───────┘               │
└──────────┼────────────────────┼────────────────────┼────────────────────────┘
           │                    │                    │
           └────────────────────┼────────────────────┘
                                │ HTTP/HTTPS
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端层 (React)                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Nginx 静态资源服务器                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  用户模块    │  │  活动模块    │  │  签到模块    │  │  管理模块   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │  公共组件：路由、状态管理、请求封装、高德地图集成              │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                │ RESTful API (JSON)
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              后端层 (SpringBoot)                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Controller 控制层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ 用户接口  │ │ 活动接口  │ │ 报名接口  │ │ 签到接口  │ │ 其他接口  │  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Service 业务层                               │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ 用户服务  │ │ 活动服务  │ │ 报名服务  │ │ 签到服务  │ │ 其他服务  │  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Mapper 数据访问层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ UserMapper│ │ActivityM│ │RegistrM  │ │CheckInM  │ │ 其他Mapper│  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  公共模块：安全认证(JWT)、全局异常、统一响应、参数校验、日志          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                │ JDBC
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据层                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         MySQL 8.0                                    │   │
│  │                      数据库：hiking_system                           │   │
│  │                         15张业务表                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、后端分层架构

### 3.1 分层结构

采用经典的 **MVC三层架构** + **DTO/VO分离**：

```
┌─────────────────────────────────────────────────────────────────┐
│                        请求入口                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Filter 过滤器层                                                 │
│  ├── JwtAuthenticationFilter (JWT认证过滤器)                     │
│  └── CorsFilter (跨域过滤器)                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Controller 控制层                                               │
│  ├── 接收HTTP请求，参数校验                                      │
│  ├── 调用Service处理业务                                         │
│  └── 返回统一响应结果 (Result<T>)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Service 业务层                                                  │
│  ├── 业务逻辑处理                                                │
│  ├── 事务管理 (@Transactional)                                   │
│  ├── 数据转换 (Entity <-> DTO/VO)                               │
│  └── 调用Mapper访问数据                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Mapper 数据访问层                                               │
│  ├── 继承 BaseMapper (MyBatis-Plus)                             │
│  ├── 自定义SQL查询                                               │
│  └── 数据库CRUD操作                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Entity 实体层                                                   │
│  └── 与数据库表一一对应的Java实体类                               │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 包结构设计

```
com.hiking
├── config/                     # 配置类
│   ├── SecurityConfig.java     # Spring Security配置
│   ├── CorsConfig.java         # 跨域配置
│   ├── MyBatisPlusConfig.java  # MyBatis-Plus配置
│   └── SwaggerConfig.java      # 接口文档配置
│
├── common/                     # 公共模块
│   ├── result/                 # 统一响应
│   │   ├── Result.java         # 响应封装类
│   │   └── ResultCode.java     # 响应状态码
│   ├── exception/              # 异常处理
│   │   ├── BusinessException.java    # 业务异常
│   │   └── GlobalExceptionHandler.java # 全局异常处理器
│   ├── constant/               # 常量定义
│   └── utils/                  # 工具类
│       ├── JwtUtils.java       # JWT工具
│       └── GeoUtils.java       # 地理计算工具
│
├── security/                   # 安全模块
│   ├── JwtAuthenticationFilter.java  # JWT过滤器
│   ├── UserDetailsServiceImpl.java   # 用户详情服务
│   └── SecurityUtils.java      # 安全工具类
│
├── module/                     # 业务模块
│   ├── user/                   # 用户模块
│   │   ├── controller/
│   │   ├── service/
│   │   ├── mapper/
│   │   ├── entity/
│   │   ├── dto/
│   │   └── vo/
│   ├── activity/               # 活动模块
│   ├── registration/           # 报名模块
│   ├── route/                  # 路线模块
│   ├── checkin/                # 签到模块
│   ├── review/                 # 评价模块
│   ├── message/                # 消息模块
│   └── system/                 # 系统模块（字典等）
│
└── HikingApplication.java      # 启动类
```

### 3.3 数据对象定义

| 对象类型 | 命名规范 | 用途 | 示例 |
|----------|----------|------|------|
| Entity | XxxEntity 或 Xxx | 数据库实体，与表对应 | User, Activity |
| DTO | XxxDTO | 数据传输对象，接收请求参数 | UserLoginDTO, ActivityCreateDTO |
| VO | XxxVO | 视图对象，返回给前端 | UserVO, ActivityDetailVO |
| Query | XxxQuery | 查询条件对象 | ActivityQuery |

---

## 四、前端架构

### 4.1 技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         React 应用                               │
├─────────────────────────────────────────────────────────────────┤
│  路由层 (React Router)                                          │
│  ├── 公开路由 (登录、注册、活动列表)                              │
│  └── 私有路由 (需登录：个人中心、报名、签到等)                     │
├─────────────────────────────────────────────────────────────────┤
│  页面层 (Pages)                                                  │
│  ├── 用户页面 (登录、注册、个人中心)                              │
│  ├── 活动页面 (列表、详情、发布、管理)                            │
│  ├── 签到页面 (签到、轨迹)                                       │
│  └── 管理页面 (审核、统计)                                       │
├─────────────────────────────────────────────────────────────────┤
│  组件层 (Components)                                             │
│  ├── 通用组件 (Header, Footer, Loading)                         │
│  ├── 业务组件 (ActivityCard, CheckInButton, MapView)            │
│  └── 布局组件 (MainLayout, AdminLayout)                         │
├─────────────────────────────────────────────────────────────────┤
│  服务层 (Services/API)                                           │
│  ├── Axios 封装 (请求拦截、响应拦截、错误处理)                    │
│  └── API 模块 (userApi, activityApi, checkinApi)                │
├─────────────────────────────────────────────────────────────────┤
│  工具层 (Utils)                                                  │
│  ├── 存储工具 (localStorage封装)                                 │
│  ├── 格式化工具 (日期、金额)                                     │
│  └── 地图工具 (高德地图封装)                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 目录结构

```
src/
├── api/                        # API请求模块
│   ├── request.js              # Axios封装
│   ├── user.js                 # 用户相关API
│   ├── activity.js             # 活动相关API
│   ├── registration.js         # 报名相关API
│   ├── checkin.js              # 签到相关API
│   └── ...
│
├── assets/                     # 静态资源
│   ├── images/
│   └── styles/
│
├── components/                 # 公共组件
│   ├── common/                 # 通用组件
│   │   ├── Header/
│   │   ├── Footer/
│   │   └── Loading/
│   ├── business/               # 业务组件
│   │   ├── ActivityCard/
│   │   ├── MapView/
│   │   └── CheckInButton/
│   └── layout/                 # 布局组件
│       ├── MainLayout/
│       └── AdminLayout/
│
├── pages/                      # 页面组件
│   ├── user/                   # 用户相关页面
│   │   ├── Login/
│   │   ├── Register/
│   │   └── Profile/
│   ├── activity/               # 活动相关页面
│   │   ├── List/
│   │   ├── Detail/
│   │   └── Create/
│   ├── checkin/                # 签到相关页面
│   └── admin/                  # 管理后台页面
│
├── router/                     # 路由配置
│   └── index.jsx
│
├── utils/                      # 工具函数
│   ├── auth.js                 # 认证相关
│   ├── storage.js              # 存储相关
│   ├── format.js               # 格式化
│   └── map.js                  # 地图相关
│
├── hooks/                      # 自定义Hooks
│   ├── useAuth.js
│   └── useLocation.js
│
├── App.jsx                     # 根组件
├── main.jsx                    # 入口文件
└── index.css                   # 全局样式
```

---

## 五、安全架构

### 5.1 认证流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户     │     │  前端     │     │  后端     │     │  数据库   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.输入账号密码  │                │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 2.登录请求      │                │
     │                │───────────────>│                │
     │                │                │                │
     │                │                │ 3.查询用户     │
     │                │                │───────────────>│
     │                │                │<───────────────│
     │                │                │                │
     │                │                │ 4.验证密码     │
     │                │                │ (BCrypt)       │
     │                │                │                │
     │                │ 5.返回JWT Token│                │
     │                │<───────────────│                │
     │                │                │                │
     │                │ 6.存储Token    │                │
     │                │ (localStorage) │                │
     │                │                │                │
     │ 7.登录成功     │                │                │
     │<───────────────│                │                │
     │                │                │                │
```

### 5.2 请求认证流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户     │     │  前端     │     │  后端     │     │  业务处理 │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.操作请求     │                │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 2.携带Token请求│                │
     │                │ (Header:       │                │
     │                │  Authorization)│                │
     │                │───────────────>│                │
     │                │                │                │
     │                │                │ 3.JWT过滤器    │
     │                │                │ 验证Token有效性│
     │                │                │                │
     │                │                │ 4.解析用户信息 │
     │                │                │ 存入Security   │
     │                │                │ Context        │
     │                │                │                │
     │                │                │ 5.权限校验     │
     │                │                │───────────────>│
     │                │                │                │
     │                │                │ 6.业务处理     │
     │                │                │<───────────────│
     │                │                │                │
     │                │ 7.返回结果     │                │
     │                │<───────────────│                │
     │                │                │                │
     │ 8.显示结果     │                │                │
     │<───────────────│                │                │
```

### 5.3 权限控制（RBAC）

| 角色 | 权限范围 |
|------|----------|
| **普通用户 (role=0)** | 浏览活动、报名、签到、评价、个人信息管理 |
| **组织者 (role=1)** | 普通用户权限 + 发布活动、审核报名、管理活动 |
| **管理员 (role=2)** | 所有权限 + 活动审核、用户管理、数据统计 |

### 5.4 接口权限示例

| 接口 | 权限要求 |
|------|----------|
| `POST /api/auth/login` | 无需登录 |
| `GET /api/activity/list` | 无需登录 |
| `POST /api/registration` | 需登录（普通用户） |
| `POST /api/activity` | 需登录（组织者） |
| `PUT /api/activity/{id}/audit` | 需登录（管理员） |

---

## 六、接口规范

### 6.1 URL设计规范

| 规范 | 说明 | 示例 |
|------|------|------|
| RESTful风格 | 资源名词复数 | `/api/activities` |
| 层级关系 | 父子资源 | `/api/activities/{id}/registrations` |
| 版本控制 | 可选 | `/api/v1/activities` |

### 6.2 HTTP方法

| 方法 | 用途 | 示例 |
|------|------|------|
| GET | 查询资源 | `GET /api/activities` |
| POST | 创建资源 | `POST /api/activities` |
| PUT | 全量更新 | `PUT /api/activities/{id}` |
| PATCH | 部分更新 | `PATCH /api/activities/{id}/status` |
| DELETE | 删除资源 | `DELETE /api/activities/{id}` |

### 6.3 统一响应格式

```json
{
    "code": 200,
    "message": "操作成功",
    "data": {
        // 业务数据
    },
    "timestamp": 1703318400000
}
```

### 6.4 响应状态码

| code | 说明 |
|------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证（未登录） |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
| 1001 | 用户名已存在 |
| 1002 | 密码错误 |
| 2001 | 活动不存在 |
| 2002 | 报名已截止 |
| ... | 业务错误码 |

### 6.5 分页响应格式

```json
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "records": [],
        "total": 100,
        "size": 10,
        "current": 1,
        "pages": 10
    }
}
```

---

## 七、部署架构

### 7.1 开发环境

```
┌─────────────────────────────────────────────────────────────────┐
│                        开发者电脑                                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  前端开发    │    │  后端开发    │    │  MySQL      │         │
│  │  (Vite)     │    │ (SpringBoot)│    │  (本地)     │         │
│  │  端口:5173  │───>│  端口:8080  │───>│  端口:3306  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 生产环境（单机部署）

```
┌─────────────────────────────────────────────────────────────────┐
│                        云服务器                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     Nginx                                │   │
│  │  ├── 静态资源服务 (前端打包文件)                          │   │
│  │  ├── 反向代理 (/api/* -> SpringBoot)                     │   │
│  │  └── HTTPS证书管理                                       │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              SpringBoot Application                      │   │
│  │              (端口:8080，内网访问)                        │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    MySQL 8.0                             │   │
│  │                   (端口:3306)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 Nginx配置示例

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    # SSL证书
    ssl_certificate     /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 前端静态资源
    location / {
        root /var/www/hiking-web/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

## 八、扩展性设计

### 8.1 当前架构可扩展点

| 扩展点 | 当前方案 | 后续扩展 |
|--------|----------|----------|
| 缓存 | 无 | 引入Redis缓存热点数据 |
| 实时通信 | 轮询 | 升级为WebSocket |
| 文件存储 | 本地存储 | 对接OSS云存储 |
| 消息通知 | 站内消息 | 集成短信/邮件/推送 |
| 搜索 | MySQL LIKE | 引入ElasticSearch |

### 8.2 代码层面的扩展性

```java
// 缓存接口抽象，便于后续切换实现
public interface CacheService {
    void set(String key, Object value, long timeout);
    Object get(String key);
    void delete(String key);
}

// 当前：本地缓存实现
@Service
public class LocalCacheService implements CacheService { ... }

// 后续：Redis实现（只需新增，不修改原有代码）
@Service
@Primary
public class RedisCacheService implements CacheService { ... }
```

---

## 九、文档版本

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2024-12-23 | 初稿，完成系统架构设计 | - |

